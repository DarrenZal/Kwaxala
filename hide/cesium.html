<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kwaxala - Cesium 3D Terrain with KML</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.95/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.95/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            height: 100%;
        }
        .header {
            background-color: #333;
            color: white;
            padding: 10px 0;
            text-align: center;
        }
        .nav-links {
            text-align: center;
            background-color: #f2f2f2;
            padding: 10px 0;
        }
        .nav-links a {
            color: #333;
            text-decoration: none;
            padding: 5px 15px;
            margin: 0 10px;
            border: 1px solid #333;
            border-radius: 5px;
        }
        .content {
            display: flex;
            height: calc(100% - 100px); /* Adjust based on header and nav height */
        }
        .sidebar {
            width: 200px;
            background-color: #f9f9f9;
            padding: 20px;
        }
        .map-container {
            flex-grow: 1;
            position: relative;
        }
        #cesiumContainer {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Kwaxala - Cesium 3D Terrain with KML</h1>
    </div>
    <div class="nav-links">
        <a href="/1">Cesium Viewer</a>
        <a href="/2">Mapbox Viewer</a>
    </div>
    <div class="content">
        <div class="sidebar">
            <h3>KML Viewer</h3>
            <p>Explore geographical data with our interactive 3D viewer.</p>
        </div>
        <div class="map-container">
            <div id="cesiumContainer"></div>
            <div id="errorConsole"></div>
        </div>
    </div>

    <script type="module">
        import { CESIUM_ION_TOKEN } from './config.js';

        function logMessage(message) {
            console.log(message);
        }

        try {
            logMessage("Starting Cesium initialization...");
            
            Cesium.Ion.defaultAccessToken = CESIUM_ION_TOKEN;
            logMessage("Ion token set.");

            const viewer = new Cesium.Viewer('cesiumContainer', {
                terrainProvider: Cesium.createWorldTerrain(),
                animation: false,
                baseLayerPicker: false,
                fullscreenButton: false,
                geocoder: false,
                homeButton: false,
                infoBox: false,
                sceneModePicker: false,
                selectionIndicator: false,
                timeline: false,
                navigationHelpButton: false,
                navigationInstructionsInitiallyVisible: false
            });
            logMessage("Viewer created successfully with 3D terrain.");

            viewer.scene.globe.depthTestAgainstTerrain = true;

            try {
                const imageryProvider = new Cesium.WebMapTileServiceImageryProvider({
                    url: 'https://gibs.earthdata.nasa.gov/wmts/epsg4326/best/MODIS_Terra_CorrectedReflectance_TrueColor/default/{Time}/{TileMatrixSet}/{TileMatrix}/{TileRow}/{TileCol}.jpg',
                    layer: 'MODIS_Terra_CorrectedReflectance_TrueColor',
                    style: '',
                    format: 'image/jpeg',
                    tileMatrixSetID: 'GoogleMapsCompatible_Level9',
                    maximumLevel: 9,
                    times: '2023-11-22',
                    tileWidth: 256,
                    tileHeight: 256,
                    tilingScheme: new Cesium.GeographicTilingScheme(),
                    credit: new Cesium.Credit('NASA Global Imagery Browse Services')
                });
                viewer.imageryLayers.addImageryProvider(imageryProvider);
                logMessage("MODIS imagery layer added successfully.");
            } catch (error) {
                logMessage("Error adding MODIS imagery: " + error.message);
            }

            const kmlUrl = 'TFL.kml';
            logMessage("Attempting to load KML from: " + kmlUrl);

            Cesium.KmlDataSource.load(kmlUrl, {
                camera: viewer.scene.camera,
                canvas: viewer.scene.canvas,
                clampToGround: true
            }).then(function(dataSource) {
                viewer.dataSources.add(dataSource);
                viewer.zoomTo(dataSource, new Cesium.HeadingPitchRange(0, -0.5, 0));
                logMessage("KML loaded and added to viewer.");

                // Style KML entities
                dataSource.entities.values.forEach(function(entity) {
                    if (entity.polyline) {
                        entity.polyline.material = Cesium.Color.YELLOW.withAlpha(0.7);
                        entity.polyline.width = 2;
                    }
                    if (entity.polygon) {
                        entity.polygon.outline = true;
                        entity.polygon.outlineColor = Cesium.Color.YELLOW;
                        entity.polygon.outlineWidth = 2;
                        entity.polygon.material = Cesium.Color.TRANSPARENT;
                    }
                });
            }).otherwise(function(error) {
                logMessage("Error loading KML: " + error);
            });

            // Enable terrain depth test
            viewer.scene.globe.depthTestAgainstTerrain = true;

            // Adjust the camera for a 3D perspective
            viewer.scene.camera.setView({
                destination: Cesium.Cartesian3.fromDegrees(-123.1207, 49.2827, 100000), // Adjust coordinates and height as needed
                orientation: {
                    heading: Cesium.Math.toRadians(0),
                    pitch: Cesium.Math.toRadians(-45),
                    roll: 0.0
                }
            });

            logMessage("Cesium initialization complete with 3D terrain.");
        } catch (error) {
            logMessage("Error during Cesium initialization: " + error.message);
        }
    </script>
</body>
</html>